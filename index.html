<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOMO FinSphere | ç«‹å³é ç´„</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* é»‘é‡‘é¢¨æ ¼å®šç¾© */
    body { background-color: #0d1117; color: #e0e0e0; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .gold-text { color: #C9A227; }
    .border-gold { border-color: #C9A227; }
    .bg-gold { background-color: #C9A227; color: #000; }
    .bg-gold:hover { background-color: #b08d21; }
    
    .slot-card {
      background-color: #161b22; 
      border: 1px solid #30363d;
      transition: all 0.3s;
    }
    .slot-card:hover { border-color: #C9A227; transform: translateY(-2px); }
    .slot-card.selected { border: 2px solid #C9A227; background-color: rgba(201, 162, 39, 0.1); }
    
    /* è¼¸å…¥æ¡†æ¨£å¼ */
    input {
      background-color: #0d1117 !important;
      border: 1px solid #30363d !important;
      color: white !important;
    }
    input:focus { border-color: #C9A227 !important; outline: none; }
    
    /* è¼‰å…¥å‹•ç•« */
    .loader {
      border: 3px solid #30363d;
      border-top: 3px solid #C9A227;
      border-radius: 50%;
      width: 24px; height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

  <div class="mt-8 mb-6 text-center">
    <div class="w-20 h-20 mx-auto rounded-full border-2 border-gold flex items-center justify-center bg-gray-900 shadow-lg">
      <span class="text-3xl">M</span>
    </div>
    <h1 class="text-2xl font-bold mt-4 tracking-wider text-white">MOMO <span class="gold-text">FinSphere</span></h1>
    <p class="text-gray-500 text-sm mt-1">VIP å°ˆå±¬é ç´„ç³»çµ±</p>
  </div>

  <div class="w-full max-w-md mb-6">
    <h3 class="text-lg font-bold mb-3 border-l-4 border-gold pl-3 text-white">1. é¸æ“‡é ç´„æ™‚æ®µ</h3>
    <div id="slots-container" class="space-y-3">
      <div class="text-center py-8 text-gray-500 flex flex-col items-center">
        <div class="loader mb-2"></div>
        è¼‰å…¥æ™‚æ®µä¸­...
      </div>
    </div>
  </div>

  <div class="w-full max-w-md mb-8 opacity-50 pointer-events-none transition" id="form-section">
    <h3 class="text-lg font-bold mb-3 border-l-4 border-gold pl-3 text-white">2. å¡«å¯«è¯çµ¡è³‡è¨Š</h3>
    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4">
      
      <div>
        <label class="block text-sm text-gray-400 mb-1">æ‚¨çš„å§“å / Name</label>
        <input type="text" id="name" class="w-full p-3 rounded" placeholder="è«‹è¼¸å…¥å§“å">
      </div>

      <div>
        <label class="block text-sm text-gray-400 mb-1">æ‰‹æ©Ÿè™Ÿç¢¼ / Phone</label>
        <input type="tel" id="phone" class="w-full p-3 rounded" placeholder="ä¾‹å¦‚: 0912345678">
      </div>

      <div>
        <label class="block text-sm text-gray-400 mb-1">é›»å­ä¿¡ç®± / Email</label>
        <input type="email" id="email" class="w-full p-3 rounded" placeholder="æ¥æ”¶é ç´„é€šçŸ¥ç”¨">
      </div>

      <button onclick="submitBooking()" id="submitBtn" class="w-full bg-gold py-3 rounded font-bold text-lg shadow-lg mt-4 flex justify-center items-center">
        ç¢ºèªé ç´„
      </button>

    </div>
  </div>

  <div class="mb-10 text-center">
    <a href="check.html" class="text-gray-500 underline hover:text-white text-sm">æŸ¥è©¢æˆ–æ˜¯å–æ¶ˆé ç´„ ></a>
  </div>

  <script>
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨çš„ GAS Web App URL ğŸ‘‡ğŸ‘‡ğŸ‘‡
    const API_URL = "https://script.google.com/macros/s/AKfycbx8sk537G4UQc_DOFI-KCK4Ea5jzb4FKoWim867NMoLRt4r5pOCACam5LrjyaC6pZkt/exec";

    let selectedSlotId = null;

    // é é¢è¼‰å…¥æ™‚å–å¾—æ™‚æ®µ
    window.onload = function() {
      fetchSlots();
    };

    function fetchSlots() {
      // é€å‡º POST è«‹æ±‚ action: getSlots
      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "getSlots" })
      })
      .then(res => res.json())
      .then(data => {
        renderSlots(data.slots);
      })
      .catch(err => {
        document.getElementById('slots-container').innerHTML = `<div class="text-red-500 text-center">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>`;
        console.error(err);
      });
    }

    function renderSlots(slots) {
      const container = document.getElementById('slots-container');
      container.innerHTML = "";

      if (!slots || slots.length === 0) {
        container.innerHTML = `<div class="text-gray-500 text-center py-4">ç›®å‰ç„¡é–‹æ”¾æ™‚æ®µ</div>`;
        return;
      }

      slots.forEach(slot => {
        const div = document.createElement('div');
        // æ ¼å¼åŒ–æ—¥æœŸ
        const timeObj = new Date(slot.time);
        const dateStr = `${timeObj.getMonth()+1}/${timeObj.getDate()} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][timeObj.getDay()]})`;
        const timeStr = `${String(timeObj.getHours()).padStart(2,'0')}:${String(timeObj.getMinutes()).padStart(2,'0')}`;

        div.className = "slot-card p-4 rounded-lg cursor-pointer flex justify-between items-center";
        div.innerHTML = `
          <div>
            <div class="font-bold text-lg text-white">${dateStr} ${timeStr}</div>
            <div class="text-sm text-gray-400">${slot.title}</div>
          </div>
          <div class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">å‰© ${slot.left} ä½</div>
        `;
        
        div.onclick = () => selectSlot(div, slot.id);
        container.appendChild(div);
      });
    }

    function selectSlot(el, id) {
      // ç§»é™¤å…¶ä»–é¸æ“‡æ¨£å¼
      document.querySelectorAll('.slot-card').forEach(c => c.classList.remove('selected'));
      // åŠ ä¸Šç›®å‰é¸æ“‡æ¨£å¼
      el.classList.add('selected');
      selectedSlotId = id;
      
      // å•Ÿç”¨ä¸‹æ–¹è¡¨å–®
      const form = document.getElementById('form-section');
      form.classList.remove('opacity-50', 'pointer-events-none');
      form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function submitBooking() {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!selectedSlotId) return alert("è«‹å…ˆé¸æ“‡æ™‚æ®µ");
      if (!name || !phone || !email) return alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");

      const btn = document.getElementById('submitBtn');
      const originalText = btn.innerText;
      btn.disabled = true;
      btn.innerHTML = `<div class="loader border-gray-800 border-t-black"></div>`; // æŒ‰éˆ•è®Šè½‰åœˆåœˆ

      const payload = {
        action: "booking",
        slotId: selectedSlotId,
        user: { name, phone, email }
      };

      fetch(API_URL, {
        method: "POST",
        // ğŸ’¡ é—œéµï¼šä½¿ç”¨ text/plain é¿å… CORS é æª¢è«‹æ±‚å¤±æ•—
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(response => {
        if (response.success) {
          alert("âœ… é ç´„æˆåŠŸï¼è«‹æŸ¥çœ‹æ‚¨çš„ä¿¡ç®±ã€‚");
          location.href = "check.html"; // è·³è½‰åˆ°æŸ¥è©¢é 
        } else {
          alert("âŒ å¤±æ•—ï¼š" + response.msg);
          btn.disabled = false;
          btn.innerText = originalText;
        }
      })
      .catch(err => {
        alert("ç³»çµ±éŒ¯èª¤ï¼š" + err);
        btn.disabled = false;
        btn.innerText = originalText;
      });
    }
  </script>
</body>
</html>
